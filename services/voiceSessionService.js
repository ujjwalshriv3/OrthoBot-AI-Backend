const VoiceSession = require('../models/VoiceSession');
const ConversationalAgent = require('../conversationalAgent');

class VoiceSessionService {
  constructor() {
    this.conversationalAgent = new ConversationalAgent();
  }

  // Start a new voice session or resume existing one
  async startVoiceSession(userId, sessionType = 'voice_call') {
    try {
      const session = await VoiceSession.findOrCreateSession(userId, sessionType);
      await session.startCall();
      
      return {
        sessionId: session.sessionId,
        isNewSession: session.stats.totalCalls === 1,
        context: session.getContextSummary(),
        preferences: session.preferences
      };
    } catch (error) {
      console.error('Error starting voice session:', error);
      throw new Error('Failed to start voice session');
    }
  }

  // End current voice session
  async endVoiceSession(sessionId) {
    try {
      const session = await VoiceSession.findOne({ sessionId });
      if (session) {
        await session.endCall();
        return {
          sessionId: session.sessionId,
          duration: session.stats.lastCallDuration,
          totalCalls: session.stats.totalCalls
        };
      }
      return null;
    } catch (error) {
      console.error('Error ending voice session:', error);
      throw new Error('Failed to end voice session');
    }
  }

  // Process message with session context
  async processMessageWithContext(sessionId, userMessage, groqApiKey) {
    try {
      const session = await VoiceSession.findOne({ sessionId });
      if (!session) {
        throw new Error('Session not found');
      }

      // Detect language and emotion
      const language = this.conversationalAgent.detectLanguage(userMessage);
      const emotion = this.conversationalAgent.detectEmotion(userMessage);

      // Add user message to session
      await session.addMessage('user', userMessage, language, emotion);

      // Get session context for enhanced prompt
      const contextSummary = session.getContextSummary();
      
      // Generate enhanced system prompt with session memory
      const enhancedPrompt = this.generateSessionAwarePrompt(language, emotion, contextSummary, session.preferences);

      // Get AI response using conversational agent with session context
      const conversationContext = this.buildConversationContext(session);
      const response = await this.getAIResponseWithMemory(enhancedPrompt, userMessage, conversationContext, groqApiKey);

      // Add AI response to session
      await session.addMessage('assistant', response, language, 'neutral');

      // Update session context based on conversation
      await this.updateSessionContext(session, userMessage, response, language);

      return {
        response,
        detectedLanguage: language,
        detectedEmotion: emotion,
        sessionContext: session.getContextSummary(),
        isActive: session.isActive
      };

    } catch (error) {
      console.error('Error processing message with context:', error);
      throw new Error('Failed to process message');
    }
  }

  // New: Handle a single voice message with full conversation memory in system prompt
  async handleVoiceMessage(sessionId, userMessage, groqApiKey) {
    try {
      // Safety check for harmful queries about increasing pain
      const harmfulPainQueries = [
        'increase knee pain', 'рдмрдврд╝рд╛рдирд╛ рдШреБрдЯрдиреЗ рдХрд╛ рджрд░реНрдж', 'badhana ghutne ka dard',
        'make knee hurt more', 'рдШреБрдЯрдиреЗ рдореЗрдВ рдЬреНрдпрд╛рджрд╛ рджрд░реНрдж рдХрд░рдирд╛', 'ghutne mein zyada dard karna',
        'increase pain', 'рджрд░реНрдж рдмрдврд╝рд╛рдирд╛', 'dard badhana',
        'hurt more', 'рдФрд░ рджрд░реНрдж рдХрд░рдирд╛', 'aur dard karna',
        'make it worse', 'рдФрд░ рдЦрд░рд╛рдм рдХрд░рдирд╛', 'aur kharab karna',
        'increase swelling', 'рд╕реВрдЬрди рдмрдврд╝рд╛рдирд╛', 'sujan badhana',
        'increase inflammation', 'рд╕реВрдЬрди рдмрдврд╝рд╛рдирд╛', 'sujan badhana'
      ];

      const isHarmfulQuery = harmfulPainQueries.some(pattern =>
        userMessage.toLowerCase().includes(pattern.toLowerCase())
      );

      if (isHarmfulQuery) {
        const language = this.conversationalAgent.detectLanguage(userMessage);

        if (language === 'hindi') {
          return {
            response: "рдореИрдВ рдЖрдкрдХреЛ рдРрд╕рд╛ рдХрд░рдиреЗ рдХреА рд╕рд▓рд╛рд╣ рдирд╣реАрдВ рджреЗ рд╕рдХрддреА! рдШреБрдЯрдиреЗ рдореЗрдВ рджрд░реНрдж рдХреЛ рдмрдврд╝рд╛рдирд╛ рд╕реНрд╡рд╛рд╕реНрдереНрдп рдХреЗ рд▓рд┐рдП рд╣рд╛рдирд┐рдХрд╛рд░рдХ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред рдХреНрдпрд╛ рдЖрдкрдХреЛ рдШреБрдЯрдиреЗ рдХреЗ рджрд░реНрдж рдХреЗ рдХрд╛рд░рдг рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдирд╛ рд╣реИ? рдпрд╛ рдлрд┐рд░ рдШреБрдЯрдиреЗ рдХреЗ рджрд░реНрдж рдХреЛ рдХрдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рд╕рд▓рд╛рд╣ рдЪрд╛рд╣рд┐рдП?",
            detectedLanguage: language,
            detectedEmotion: 'neutral',
            sessionContext: {},
            isActive: true
          };
        } else {
          return {
            response: "I cannot advise you to do that! Increasing knee pain can be harmful to your health. Do you want to know about the causes of knee pain? Or do you need some advice to reduce knee pain?",
            detectedLanguage: language,
            detectedEmotion: 'neutral',
            sessionContext: {},
            isActive: true
          };
        }
      }

      const axios = require('axios');
      const session = await VoiceSession.findOne({ sessionId });
      if (!session) {
        throw new Error('Session not found');
      }

      // 1) Detect language/emotion and add user message to session
      const language = this.conversationalAgent.detectLanguage(userMessage);
      const emotion = this.conversationalAgent.detectEmotion(userMessage);
      await session.addMessage('user', userMessage, language, emotion);

      // 2) Use conversational agent with Dr. Rameshwar KB support
      const conversationalResult = await this.conversationalAgent.processMessage(
        sessionId, 
        userMessage, 
        groqApiKey,
        null, // cohere client - not needed for Dr. Rameshwar KB
        null  // supabase client - not needed for Dr. Rameshwar KB
      );

      const aiResponse = conversationalResult.response;

      // 5) Store bot response into session
      await session.addMessage('assistant', aiResponse, language, 'neutral');

      // 6) Return response (and some metadata) for TTS playback
      return {
        response: aiResponse,
        detectedLanguage: language,
        detectedEmotion: emotion,
        sessionContext: session.getContextSummary(),
        isActive: session.isActive
      };
    } catch (error) {
      console.error('Error handling voice message:', error);
      throw new Error('Failed to handle voice message');
    }
  }

  // Generate session-aware system prompt
  generateSessionAwarePrompt(language, emotion, contextSummary, preferences) {
    const callHistory = contextSummary.callHistory.totalCalls > 1 ? 
      `This is call #${contextSummary.callHistory.totalCalls} with this user. Previous calls averaged ${contextSummary.callHistory.averageDuration} seconds.` : 
      'This is the first call with this user.';

    const topicContext = contextSummary.primaryTopics.length > 0 ? 
      `Previous topics discussed: ${contextSummary.primaryTopics.join(', ')}. Current focus: ${contextSummary.currentTopic || 'General consultation'}.` : 
      'No previous conversation history.';

    const patientContext = contextSummary.patientCondition ? 
      `Patient condition: ${contextSummary.patientCondition}. Recovery stage: ${contextSummary.recoveryStage || 'Not specified'}.` : 
      'Patient condition not yet established.';

    const concernsContext = contextSummary.recentConcerns.length > 0 ? 
      `Recent concerns: ${contextSummary.recentConcerns.join(', ')}.` : 
      'No specific concerns noted yet.';

    const recentConversation = contextSummary.recentConversation ? 
      `Recent conversation context:\n${contextSummary.recentConversation}` : 
      'No recent conversation history.';

    return `You are OrthoBot AI, a caring healthcare companion with PERFECT MEMORY of ALL conversations during this call. You NEVER forget anything the user tells you. You are a female assistant and must use feminine forms in Hindi responses.

COMPLETE CONVERSATION MEMORY:
${recentConversation}

MEMORY CONTEXT:
${callHistory}
${topicContext}
${patientContext}
${concernsContext}

CRITICAL MEMORY RULES:
- You have PERFECT RECALL of EVERYTHING said in this call
- NEVER say "I don't remember" or "I forgot" - you remember EVERYTHING
- Reference specific details from ANY point in this conversation
- If user asks about something they mentioned earlier, recall it EXACTLY
- Remember names, treatments, doctors, symptoms, dates - ALL details
- Show you remember by referencing specific things they told you

CORE IDENTITY:
- You REMEMBER this user and reference previous conversations naturally
- Talk like a caring friend who knows their medical history
- Show continuity by referencing past discussions when relevant
- Be genuinely warm and conversational, not formal or robotic
- Specialized in orthopedic care and recovery

ЁЯЧгя╕П **Response Style Rules:**
1. Always sound **natural, caring, and positive** тАФ like a human physiotherapist.
2. Mix **short Hindi and simple English** naturally (Hinglish tone is fine).
3. Never sound robotic or scripted. Avoid repeating template-like phrases.
4. Keep the tone encouraging тАФ even if user says something unusual or funny.
ЁЯТм **Special Handling Instructions:**
1. If user says **they are in pain**:
- Respond empathetically first.
- Ask when the pain started, how severe it is, and offer helpful next steps.
Example:
> тАЬрдореИрдВ рд╕рдордЭ рд╕рдХрддрд╛ рд╣реВрдБ рдХрд┐ рджрд░реНрдж рддрдХрд▓реАрдлрд╝рджреЗрд╣ рд╣реЛрддрд╛ рд╣реИред рдХреНрдпрд╛ рдЖрдк рдмрддрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдпреЗ рджрд░реНрдж рдХрдм рд╕реЗ рд╣реИ рдФрд░ рдХрд╣рд╛рдБ рдЬрд╝реНрдпрд╛рджрд╛ рдорд╣рд╕реВрд╕ рд╣реЛ рд░рд╣рд╛ рд╣реИ?тАЭ
2. If user says **they are NOT in pain** (e.g., тАЬрдШреБрдЯрдиреЗ рдореЗрдВ рджрд░реНрдж рдирд╣реАрдВ рд╣реЛ рд░рд╣рд╛тАЭ):
- Respond positively and encourage them to maintain recovery.
Example:
> тАЬрдмрд╣реБрдд рдмрдврд╝рд┐рдпрд╛! рдЗрд╕рдХрд╛ рдорддрд▓рдм рдЖрдкрдХреА рд░рд┐рдХрд╡рд░реА рд╕рд╣реА рджрд┐рд╢рд╛ рдореЗрдВ рдЬрд╛ рд░рд╣реА рд╣реИ рдмрд╕ рдзреНрдпрд╛рди рд░рдЦрд┐рдП рдХрд┐ рдирд┐рдпрдорд┐рдд рдПрдХреНрд╕рд░рд╕рд╛рдЗрдЬрд╝ рдФрд░ рд╕реНрдЯреНрд░реЗрдЪ рдХрд░рддреЗ рд░рд╣реЗрдВредтАЭ
 3. If user says something **confusing, irrelevant, or non-medical**:
- Gently redirect them back to a health-related topic.
Example:
> тАЬрдЕрдЪреНрдЫрд╛ ЁЯЩВ рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреЗ рдШреБрдЯрдиреЗ рдпрд╛ рдХрд┐рд╕реА рдФрд░ рд╣рдбреНрдбреА рдХреА рдкрд░реЗрд╢рд╛рдиреА рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдХрд░ рд░рд╣реЗ рд╣реИрдВ?тАЭ
4. If user asks **personal or risky questions**:
- Politely decline and remind them to consult a real doctor for medical emergencies.
Example:
> тАЬрдореИрдВ рдХреЗрд╡рд▓ рд╕рд╛рдорд╛рдиреНрдп рд╕реБрдЭрд╛рд╡ рджреЗ рд╕рдХрддрд╛ рд╣реВрдБред рдЧрдВрднреАрд░ рджрд░реНрдж рдпрд╛ рдЪреЛрдЯ рдХреА рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдЕрдкрдиреЗ рдбреЙрдХреНрдЯрд░ рд╕реЗ рддреБрд░рдВрдд рд╕рдВрдкрд░реНрдХ рдХрд░реЗрдВредтАЭ
 ЁЯзй **Personality & Behavior:**
- Talk like a friendly physiotherapist who genuinely cares.
- Stay calm, polite, and emotionally intelligent.
- DonтАЩt overuse emojis тАФ 1 or 2 max per reply.
- Always give short, easy-to-understand explanations.
ЁЯй║ **Knowledge Domain:**
You specialize in:
- Physiotherapy
- Knee and joint pain
- Post-operative recovery
- Muscle strengthening & stretching
- Exercise guidance & pain prevention
ЁЯТб **Example User Flows:**
**User:** тАЬрдореЗрд░реЗ рдШреБрдЯрдиреЗ рдореЗрдВ рджрд░реНрдж рдХреНрдпреЛрдВ рдирд╣реАрдВ рд╣реЛ рд░рд╣рд╛?тАЭ
**Bot:** тАЬрдореИрдВ рдЗрд╕рдореЗрдВ рдорджрдж рдирд╣реАрдВ рдХрд░ рд╕рдХрддреА рд╣реВрдБ рдЕрдЧрд░ рдЖрдк тАЬрдШреБрдЯрдиреЗ рдореЗрдВ рджрд░реНрдж рдмрдврд╝рд╛рдиреЗтАЭ рдХрд╛ рдорддрд▓рдм рдЬрд╛рдирдмреВрдЭрдХрд░ рджрд░реНрдж рдмрдврд╝рд╛рдирд╛ рдпрд╛ рдиреБрдХрд╕рд╛рди рдкрд╣реБрдБрдЪрд╛рдирд╛ рд▓реЗрдирд╛ рдЪрд╛рд╣ рд░рд╣реЗ рд╣реИрдВ, рддреЛ рдпрд╣ рд╕реНрд╡рд╛рд╕реНрдереНрдп рдХреЗ рд▓рд┐рдП рдЦрддрд░рдирд╛рдХ рд╣реИ тАФ рдРрд╕рд╛ рдХрд░рдирд╛ рдмрд┐рд▓реНрдХреБрд▓ рд╕реБрд░рдХреНрд╖рд┐рдд рдирд╣реАрдВ рд╣реИред рд▓реЗрдХрд┐рди рдЕрдЧрд░ рдЖрдк рдпрд╣ рд╕рдордЭрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐
тАЬрдШреБрдЯрдиреЗ рдХрд╛ рджрд░реНрдж рдХрд┐рди рдХрд╛рд░рдгреЛрдВ рд╕реЗ рдмрдврд╝ рдЬрд╛рддрд╛ рд╣реИ?тАЭ рддреЛ рдореИрдВ рдкреВрд░реА рддрд░рд╣ рдорджрдж рдХрд░ рд╕рдХрддрд╛ рд╣реВрдБ ЁЯСЗ
рдШреБрдЯрдиреЗ рдХреЗ рджрд░реНрдж рдХреЗ рдмрдврд╝рдиреЗ рдХреЗ рд╕рд╛рдорд╛рдиреНрдп рдХрд╛рд░рдг:
рдЕрддреНрдпрдзрд┐рдХ рд╡рдЬрди рдбрд╛рд▓рдирд╛ рдЬрд╝реНрдпрд╛рджрд╛ рджреЗрд░ рдЦрдбрд╝реЗ рд░рд╣рдирд╛ рдпрд╛ рджреМрдбрд╝рдирд╛
рдЧрд▓рдд рдореБрджреНрд░рд╛ (Posture)рдмреИрдардиреЗ рдпрд╛ рдЙрдардиреЗ рдХрд╛ рддрд░реАрдХрд╛ рдЧрд▓рдд рд╣реЛрдирд╛
рдорд╛рдВрд╕рдкреЗрд╢рд┐рдпреЛрдВ рдХреА рдХрдордЬреЛрд░реА рдЬрд╛рдВрдШ рдХреА рдорд╛рдВрд╕рдкреЗрд╢рд┐рдпрд╛рдБ рдХрдордЬреЛрд░ рд╣реЛрдиреЗ рд╕реЗ рдШреБрдЯрдиреЗ рдкрд░ рдЬрд╝реНрдпрд╛рджрд╛ рджрдмрд╛рд╡ рдЖрддрд╛ рд╣реИ рдЕрдЪрд╛рдирдХ рднрд╛рд░реА рд╡реНрдпрд╛рдпрд╛рдо рдпрд╛ рдЭрдЯрдХрд╛ рд▓рдЧрдирд╛ рд╕реВрдЬрди рдпрд╛ рдЧрдард┐рдпрд╛ (Arthritis) рдЬреИрд╕реА рд╕рдорд╕реНрдпрд╛ рдЕрд╕рдВрддреБрд▓рд┐рдд рдЖрд╣рд╛рд░ рдпрд╛ рдкрд╛рдиреА рдХреА рдХрдореА рдЬреЛрдбрд╝реЛрдВ рдореЗрдВ рдЪрд┐рдХрдирд╛рдИ рдХрдо рд╣реЛ рдЬрд╛рддреА рд╣реИ рдЕрдЧрд░ рдЖрдк рдЪрд╛рд╣реЗрдВ рддреЛ рдореИрдВ рдмрддрд╛ рд╕рдХрддрд╛ рд╣реВрдБ рдХрд┐ рдШреБрдЯрдиреЗ рдХрд╛ рджрд░реНрдж рдХрдо рдХрд░рдиреЗ рдпрд╛ рдареАрдХ рдХрд░рдиреЗ рдХреЗ рд╕реБрд░рдХреНрд╖рд┐рдд рддрд░реАрдХреЗ рдХреНрдпрд╛ рд╣реИрдВ тАФ рдЬреИрд╕реЗ рдлрд┐рдЬрд┐рдпреЛрдереЗрд░реЗрдкреА, рд╕реНрдЯреНрд░реЗрдЪрд┐рдВрдЧ рдПрдХреНрд╕рд░рд╕рд╛рдЗрдЬрд╝, рдФрд░ рдШрд░реЗрд▓реВ рдЙрдкрд╛рдпред

**User:** тАЬрдШреБрдЯрдиреЗ рдореЗрдВ рдлрд┐рд░ рд╕реЗ рджрд░реНрдж рд╢реБрд░реВ рд╣реЛ рдЧрдпрд╛редтАЭ
**Bot:** тАЬрд╕рдордЭ рдЧрдИ, рдРрд╕рд╛ рдХрдИ рдмрд╛рд░ рд╣реЛрддрд╛ рд╣реИред рдХреНрдпрд╛ рдЖрдк рдмрддрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рджрд░реНрдж рдХрд┐рд╕ рд╣рд┐рд╕реНрд╕реЗ рдореЗрдВ рдЬрд╝реНрдпрд╛рджрд╛ рд╣реИ рдФрд░ рдХрдм рд╕реЗ рд╣реИ?тАЭ
 тЪЩя╕П **Final Rule:**
Always think like a caring human expert тАФ not a machine.
Your job is to make the user feel heard, understood, and guided. 

**GENDER-SPECIFIC HINDI RESPONSES**: You are a female assistant. In Hindi responses, always use feminine verb forms and pronouns:
- Use "рд╣реВрдБ" instead of "рд╣реИ" for "I am"
- Use "рд╕рдХрддреА рд╣реВрдБ" instead of "рд╕рдХрддрд╛ рд╣реВрдБ" for "I can"
- Use "рдорджрдж рдХрд░ рд╕рдХрддреА рд╣реВрдБ" instead of "рдорджрдж рдХрд░ рд╕рдХрддрд╛ рд╣реВрдБ" for "I can help"
- Use "рдмрддрд╛рдКрдВрдЧреА" instead of "рдмрддрд╛рдКрдВрдЧрд╛" for "I will tell"
- Use "рд╕рдордЭ рдЧрдИ" instead of "рд╕рдордЭ рдЧрдпрд╛" for "I understood"
- Use "рдХрд░рддреА рд╣реВрдБ" instead of "рдХрд░рддрд╛ рд╣реВрдБ" for "I do"

LANGUAGE HANDLING:
- User is communicating in: ${language}
- Respond naturally in the SAME language as the user
- User prefers: ${preferences.preferredLanguage}
- Communication style: ${preferences.communicationStyle}

EMOTIONAL INTELLIGENCE:
- User's current emotional state: ${emotion}
- Show genuine empathy and understanding
- Use warm, caring, and supportive tone
- Acknowledge their feelings and reference past concerns if relevant

CONVERSATION STYLE:
- Reference previous conversations when appropriate ("Last time we talked about...")
- Show you remember their condition and progress
- Ask follow-up questions based on previous discussions
- Be ${preferences.responseLength === 'brief' ? 'concise and direct' : 'detailed and thorough'}
- Sound like you're continuing a relationship, not starting fresh
- Use natural, flowing conversational language like ChatGPT
- Avoid formal or robotic language patterns

MEDICAL EXPERTISE FOCUS:
- Post-operative care and recovery
- Orthopedic rehabilitation exercises  
- Pain management techniques
- Wound care and healing
- Mobility and physical therapy guidance
- When to contact healthcare providers
- Medication adherence support

SAFETY PROTOCOLS:
- Always include medical disclaimers when giving advice
- Recognize emergency symptoms and advise immediate medical care
- Never diagnose or prescribe medications
- Encourage professional medical consultation when needed

RESPONSE FORMAT:
- Keep responses SHORT and conversational (1-3 sentences max for voice calls)
- Reference previous conversations when relevant
- Ask ONE direct question about their current situation
- Show continuity and memory of their journey
- For voice calls: Be concise and natural, like talking to a friend you know well
- Use empathetic, warm language that shows you remember them`;
  }

  // Build conversation context from session history
  buildConversationContext(session) {
    const allHistory = session.conversationHistory; // Get ALL messages during current call
    const conversationMessages = [];
    
    console.log('ЁЯУЪ Building conversation context:', {
      totalHistoryMessages: allHistory.length,
      sessionId: session.sessionId
    });
    
    // Add ALL conversation history to maintain complete context
    allHistory.forEach((msg, index) => {
      conversationMessages.push({
        role: msg.role,
        content: msg.content
      });
      console.log(`ЁЯТм Message ${index + 1}: ${msg.role} - ${msg.content.substring(0, 50)}...`);
    });
    
    return conversationMessages;
  }

  // Get AI response with enhanced memory context
  async getAIResponseWithMemory(systemPrompt, userMessage, conversationContext, groqApiKey) {
    try {
      const axios = require('axios');
      
      // Build messages array with conversation history
      const messages = [
        { role: 'system', content: systemPrompt },
        ...conversationContext // Include previous conversation
      ];
      
      // Don't add the current user message again since it's already in conversationContext
      // Only add it if conversationContext is empty
      if (conversationContext.length === 0) {
        messages.push({ role: 'user', content: userMessage });
      }
      
      console.log('ЁЯза Sending to AI with conversation history:', {
        totalMessages: messages.length,
        historyMessages: conversationContext.length,
        lastFewMessages: messages.slice(-3)
      });
      
      const response = await axios.post(
        'https://api.groq.com/openai/v1/chat/completions',
        {
          model: 'llama-3.3-70b-versatile',
          messages: messages,
          temperature: 0.7,
          max_tokens: 200
        },
        {
          headers: {
            Authorization: `Bearer ${groqApiKey}`,
            'Content-Type': 'application/json'
          }
        }
      );

      return response.data.choices[0].message.content;
    } catch (error) {
      console.error('Error getting AI response:', error);
      throw error;
    }
  }

  // Update session context based on conversation
  async updateSessionContext(session, userMessage, aiResponse, language) {
    try {
      const contextUpdate = this.extractContextFromConversation(userMessage, aiResponse);
      
      // Update primary topics
      if (contextUpdate.topic) {
        if (!session.sessionContext.primaryTopics.includes(contextUpdate.topic)) {
          session.sessionContext.primaryTopics.push(contextUpdate.topic);
        }
        session.sessionContext.currentTopic = contextUpdate.topic;
      }

      // Update patient condition and concerns
      if (contextUpdate.condition) {
        session.sessionContext.patientCondition = contextUpdate.condition;
      }

      if (contextUpdate.concerns && contextUpdate.concerns.length > 0) {
        session.sessionContext.concerns = [
          ...new Set([...session.sessionContext.concerns, ...contextUpdate.concerns])
        ].slice(-10); // Keep last 10 concerns
      }

      if (contextUpdate.symptoms && contextUpdate.symptoms.length > 0) {
        session.sessionContext.lastDiscussedSymptoms = contextUpdate.symptoms;
      }

      // Update preferences
      if (language !== session.preferences.preferredLanguage) {
        session.preferences.preferredLanguage = language;
      }

      await session.updateContext(session.sessionContext);
    } catch (error) {
      console.error('Error updating session context:', error);
    }
  }

  // Extract context information from conversation
  extractContextFromConversation(userMessage, aiResponse) {
    const lowerMessage = userMessage.toLowerCase();
    const context = {
      topic: null,
      condition: null,
      concerns: [],
      symptoms: []
    };

    // Extract topics
    const topicPatterns = {
      'knee recovery': ['knee', 'knee pain', 'knee surgery', 'knee replacement'],
      'back pain relief': ['back pain', 'back injury', 'spine', 'lower back'],
      'shoulder rehabilitation': ['shoulder', 'shoulder pain', 'shoulder surgery'],
      'hip replacement care': ['hip', 'hip replacement', 'hip surgery', 'hip pain'],
      'post-operative care': ['post-op', 'after surgery', 'post surgery', 'recovery'],
      'exercise guidance': ['exercise', 'workout', 'physical therapy', 'stretching'],
      'pain management': ['pain relief', 'manage pain', 'reduce pain', 'medication'],
      'wound care': ['wound', 'incision', 'stitches', 'healing', 'scar']
    };

    for (const [topic, keywords] of Object.entries(topicPatterns)) {
      if (keywords.some(keyword => lowerMessage.includes(keyword))) {
        context.topic = topic;
        break;
      }
    }

    // Extract concerns
    const concernPatterns = ['worried', 'concerned', 'afraid', 'scared', 'anxious', 'problem', 'issue'];
    concernPatterns.forEach(pattern => {
      if (lowerMessage.includes(pattern)) {
        context.concerns.push(pattern);
      }
    });

    // Extract symptoms
    const symptomPatterns = ['pain', 'swelling', 'stiffness', 'numbness', 'tingling', 'weakness', 'ache'];
    symptomPatterns.forEach(symptom => {
      if (lowerMessage.includes(symptom)) {
        context.symptoms.push(symptom);
      }
    });

    return context;
  }

  // Get session information
  async getSessionInfo(sessionId) {
    try {
      const session = await VoiceSession.findOne({ sessionId });
      if (!session) {
        return null;
      }

      return {
        sessionId: session.sessionId,
        userId: session.userId,
        isActive: session.isActive,
        context: session.getContextSummary(),
        preferences: session.preferences,
        stats: session.stats,
        createdAt: session.createdAt,
        lastActiveAt: session.lastActiveAt
      };
    } catch (error) {
      console.error('Error getting session info:', error);
      return null;
    }
  }

  // Cleanup expired sessions
  async cleanupExpiredSessions() {
    try {
      const deletedCount = await VoiceSession.cleanupExpiredSessions();
      console.log(`Cleaned up ${deletedCount} expired voice sessions`);
      return deletedCount;
    } catch (error) {
      console.error('Error cleaning up expired sessions:', error);
      return 0;
    }
  }

  // Get user's session history
  async getUserSessions(userId, limit = 10) {
    try {
      const sessions = await VoiceSession.find({ userId })
        .sort({ lastActiveAt: -1 })
        .limit(limit)
        .select('sessionId sessionType stats createdAt lastActiveAt sessionContext.primaryTopics');

      return sessions.map(session => ({
        sessionId: session.sessionId,
        sessionType: session.sessionType,
        primaryTopics: session.sessionContext.primaryTopics || [],
        totalCalls: session.stats.totalCalls,
        totalDuration: session.stats.totalDuration,
        createdAt: session.createdAt,
        lastActiveAt: session.lastActiveAt
      }));
    } catch (error) {
      console.error('Error getting user sessions:', error);
      return [];
    }
  }
}

module.exports = VoiceSessionService;
